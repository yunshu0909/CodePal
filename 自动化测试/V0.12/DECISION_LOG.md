# DECISION_LOG - 2026-02-20（V0.12 启动模式自动化测试）

## 背景
- 目标：对 V0.12 启动模式能力补齐可回归的三层自动化（Backend + Integration + Electron E2E）。
- 约束：沿用现有 V0.9 的测试组织方式，不引入新框架。

## 决策

### 1. 继续采用“分层脚本 + 总入口”执行策略
- 决策：新增 `test:v12:backend`、`test:v12:integration`、`test:e2e:v12`、`test:v12:all`。
- 原因：与 V0.9 保持一致，失败归因明确，便于增量回归。

### 2. 页面补充 data-testid 作为稳定测试锚点
- 决策：在 `PermissionModePage.jsx` 增加 `data-testid` 标识（状态卡片、模式项、切换按钮、错误态、重试按钮等）。
- 原因：该页面状态分支较多，纯文本断言脆弱，易受文案微调影响。

### 3. 后端测试采用“临时 HOME + require fresh”隔离真实环境
- 决策：每次测试前切换 `HOME` 到临时目录，并重新加载 handler 模块。
- 原因：`settings.json` 路径在模块加载阶段确定，必须隔离到临时目录避免污染真实 `~/.claude`。

### 4. E2E 聚焦主链路，不做高波动权限注入
- 决策：E2E 覆盖“默认态切换、未知模式态、读取失败重试”三条主路径；不强行注入跨平台权限拒绝场景。
- 原因：权限拒绝在不同系统上稳定性差，优先保证主链路可稳定回归。

## 备选方案与取舍
- 方案 A：只做前端 Integration，不做 Electron E2E。
  - 放弃原因：无法验证 `settings.json` 真实写入行为。
- 方案 B：只在 `test:v12` 内单配置串行跑完。
  - 放弃原因：失败定位慢，问题归因成本高。
